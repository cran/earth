> # test.earth.full.R: test earth
> 
> print(R.version.string)
[1] "R version 2.5.1 (2007-06-27)"
> 
> library(earth)
Loading required package: leaps
> library(mda)
Loading required package: class
> data(ozone1)
> data(trees)
> 
> print.time <- FALSE         # FALSE for no time results (for diff against reference)
> plot.it.default <- TRUE     # TRUE to do plots too, FALSE for speed
> options.old <- options()
> options(digits = 3)
> 
> #--- test examples from man pages ------------------------------------------------------------
> 
> cat("--- earth.Rd -----------------------------\n")
--- earth.Rd -----------------------------
> example(earth)

earth> a <- earth(Volume ~ ., data = trees)

earth> summary(a, digits = 2)
Call:
earth(formula = Volume ~ ., data = trees)

Expression:
  27 
  +    6 * pmax(0,  Girth -     14) 
  -  3.2 * pmax(0,     14 -  Girth) 
  + 0.61 * pmax(0, Height -     75) 

Number of cases: 31
Selected 4 of 5 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 3 (additive model)
GCV: 11          RSS: 196         GRSq: 0.96      RSq: 0.98
> 
> a <- earth(mpg ~ ., data = mtcars, pmethod = "none", trace = 4)
Call: earth.default(x=x,y=y,trace=4,pmethod="none") 

Forward pass: model matrix 32 x 10 y 32 x 1 minspan 1 endspan 12

         GRSq    RSq     DeltaRSq       RSS Pred PredName         Cut  Terms   Parents
1      0.0000 0.0000                   1126                            1
2      0.8118 0.8572       0.8572     160.8    2     disp         160  2   3   
4      0.7752 0.8763      0.01906   139.336    3       hp         150  4   5   
6      0.7413 0.9028      0.02655   109.445    5       wt       3.435  6   7   
8      0.6266 0.9126     0.009773   98.4408    4     drat        3.23  8   9   
10     0.4195 0.9269      0.01433   82.3029    9     gear           4  10  11  
12    -0.2152 0.9380      0.01113   69.7694    1      cyl           6  12  13  
14    -4.0809 0.9524      0.01438   53.5813   10     carb           2  14  15  
16   -39.1645 0.9582     0.005789   47.0626    6     qsec        18.3  16  17  reject term

GRSq: -39.16 RSq: 0.9582
Reached min GRSq (GRSq -39.1645 < -10)
Forward pass complete: 15 terms

Subset size         GCV         GRSq      RSq  nPreds  Terms (index into bx)
          1     37.4958       0.0000   0.0000       0  1
          2      10.423       0.7220   0.7567       1  1 3
          3     7.05843       0.8118   0.8572       1  1 2 3
          4     6.64891       0.8227   0.8847       3  1 3 5 6
          5     7.70139       0.7946   0.8869       3  1 2 3 5 6
          6     8.74756       0.7667   0.8929       3  1 2 3 4 5 6
          7     9.03129       0.7591   0.9095       6  1 3 5 9 10 13 14
          8     10.0232       0.7327   0.9196       7  1 3 5 6 9 10 13 14
          9      11.356       0.6971   0.9291       7  1 3 5 6 8 9 10 13 14
         10     12.0837       0.6777   0.9433       7  1 3 5 6 8 9 10 13 14 15
         11      15.144       0.5961   0.9491       7  1 3 5 6 8 9 10 12 13 14 15
         12     21.5854       0.4243   0.9515       7  1 3 5 6 8 9 10 11 12 13 14 15
         13     35.4201       0.0554   0.9518       7  1 2 3 5 6 8 9 10 11 12 13 14 15
         14     68.7016      -0.8322   0.9523       7  1 2 3 4 5 6 8 9 10 11 12 13 14 15
chosen   15     190.511      -4.0809   0.9524       7  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15

Prune method "none" ppenalty 2 nprune 15: selected 15 of 15 terms, and 7 of 10 predictors
GRSq: -4.081 RSq: 0.9524 
> 
> set.seed(1)
> train.subset <- sample(1:nrow(trees), .8 * nrow(trees))
> test.subset <- (1:nrow(trees))[-train.subset]
> a <- earth(Volume ~ ., data = trees[train.subset, ])
> yhat <- predict(a, newdata = trees[test.subset, ])
> y <- trees$Volume[test.subset]
> print(1 - sum((y - yhat)^2) / sum((y - mean(y))^2)) # print R-Squared
[1] 0.959
> cat("--- print.default of earth object---------\n")
--- print.default of earth object---------
> print.default(a, digits=3)
$bx
      (Intercept) h(Girth-12) h(12-Girth) h(Height-75)
 [1,]           1         0.0         0.9            5
 [2,]           1         0.0         0.6            1
 [3,]           1         0.9         0.0           10
 [4,]           1         5.3         0.0            6
 [5,]           1         0.0         1.2            8
 [6,]           1         4.0         0.0            0
 [7,]           1         5.9         0.0            5
 [8,]           1         0.9         0.0            0
 [9,]           1         0.0         0.0            0
[10,]           1         0.0         3.4            0
[11,]           1         0.0         1.3            6
[12,]           1         0.0         1.5            0
[13,]           1         0.0         0.3            0
[14,]           1         0.0         1.0            0
[15,]           1         1.7         0.0            0
[16,]           1         0.0         1.0            0
[17,]           1         0.0         0.7            4
[18,]           1         6.0         0.0            5
[19,]           1         2.0         0.0            3
[20,]           1         0.0         0.8            0
[21,]           1         2.5         0.0            0
[22,]           1         0.0         3.2            0
[23,]           1         5.5         0.0            7
[24,]           1         2.2         0.0            5

$dirs
             Girth Height
(Intercept)      0      0
h(Girth-12)      1      0
h(12-Girth)     -1      0
h(Height-75)     0      1
h(75-Height)     0     -1

$cuts
             Girth Height
(Intercept)      0      0
h(Girth-12)     12      0
h(12-Girth)     12      0
h(Height-75)     0     75
h(75-Height)     0     75

$selected.terms
[1] 1 2 3 4

$prune.terms
     [,1] [,2] [,3] [,4] [,5]
[1,]    1    0    0    0    0
[2,]    1    2    0    0    0
[3,]    1    2    3    0    0
[4,]    1    2    3    4    0
[5,]    1    2    3    4    5

$rss
[1] 133

$rsq
[1] 0.972

$gcv
[1] 11.1

$grsq
[1] 0.949

$rss.per.response
[1] 133

$rsq.per.response
[1] 0.972

$gcv.per.response
[1] 11.1

$grsq.per.response
[1] 0.949

$rss.per.subset
[1] 4739  419  257  133  128

$gcv.per.subset
[1] 215.0  22.8  17.1  11.1  13.6

$fitted.values
   [,1]
9  21.4
12 19.1
17 32.7
26 52.6
6  22.8
24 41.1
28 55.0
16 24.9
15 20.1
2  10.1
5  21.0
4  15.7
14 19.3
7  17.2
19 29.1
8  17.2
11 21.2
29 55.5
21 33.0
10 17.8
23 33.3
3  10.6
27 54.5
22 35.6

$residuals
     [,1]
9   1.230
12  1.853
17  1.140
26  2.755
6  -3.115
24 -2.849
28  3.284
16 -2.675
15 -1.050
2   0.247
5  -2.161
4   0.705
14  2.041
7  -1.580
19 -3.374
8   1.020
11  3.015
29 -4.041
21  1.515
10  2.126
23  3.026
3  -0.447
27  1.227
22 -3.892

$coefficients
               [,1]
(Intercept)  20.150
h(Girth-12)   5.250
h(12-Girth)  -2.970
h(Height-75)  0.779

$ppenalty
[1] 2

$call
earth(formula = Volume ~ ., data = trees[train.subset, ])

$terms
Volume ~ Girth + Height
attr(,"variables")
list(Volume, Girth, Height)
attr(,"factors")
       Girth Height
Volume     0      0
Girth      1      0
Height     0      1
attr(,"term.labels")
[1] "Girth"  "Height"
attr(,"order")
[1] 1 1
attr(,"intercept")
[1] 1
attr(,"response")
[1] 1
attr(,".Environment")
<environment: R_GlobalEnv>
attr(,"predvars")
list(Volume, Girth, Height)
attr(,"dataClasses")
   Volume     Girth    Height 
"numeric" "numeric" "numeric" 

attr(,"class")
[1] "earth"
> cat("--- done print.default of earth object----\n")
--- done print.default of earth object----
> plot(a)
> library(mda)
> (a <- fda(Species~., data=iris, method=earth, keepxy=TRUE))
Call:
fda(formula = Species ~ ., data = iris, method = earth, keepxy = TRUE)

Dimension: 2 

Percent Between-Group Variance Explained:
   v1    v2 
 92.7 100.0 

Training Misclassification Error: 0.0333 ( N = 150 )
> plot(a)
> print(summary(a$fit))
Call:
earth(x = x, y = Theta, weights = weights, keepxy = TRUE)

Response 1 expression:
  -2.17 
  - 0.206 * pmax(0, Sepal.Length -          5.4) 
  + 0.182 * pmax(0,  Sepal.Width -          3.2) 
  + 0.032 * pmax(0,          3.2 -  Sepal.Width) 
  + 0.845 * pmax(0,          4.5 - Petal.Length) 
  - 0.888 * pmax(0, Petal.Length -          5.3) 
  +  1.01 * pmax(0, Petal.Length -          3.5) 
  + 0.384 * pmax(0,  Petal.Width -          1.2) 
  + 0.801 * pmax(0,          1.2 -  Petal.Width) 
  -  2.35 * pmax(0,  Petal.Width -          1.9) 
  +  1.59 * pmax(0,  Petal.Width -          1.6) 

Response 2 expression:
  -1.68 
  -  0.274 * pmax(0, Sepal.Length -          5.4) 
  + 0.0875 * pmax(0,  Sepal.Width -          3.2) 
  +  0.457 * pmax(0,          3.2 -  Sepal.Width) 
  +  0.417 * pmax(0,          4.5 - Petal.Length) 
  -  0.829 * pmax(0, Petal.Length -          5.3) 
  +   1.11 * pmax(0, Petal.Length -          3.5) 
  +  0.414 * pmax(0,  Petal.Width -          1.2) 
  -  0.349 * pmax(0,          1.2 -  Petal.Width) 
  -   4.63 * pmax(0,  Petal.Width -          1.9) 
  +   3.85 * pmax(0,  Petal.Width -          1.6) 

Number of cases: 300
Selected 11 of 13 terms, and 4 of 4 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.064        RSS: 7.1          GRSq: 0.968      RSq: 0.976
Response 2  GCV: 0.145        RSS: 16.1         GRSq: 0.929      RSq: 0.946
All         GCV: 0.195        RSS: 21.6         GRSq: 0.967      RSq: 0.975
> plot(a$fit)
> plotmo(a$fit, ycolumn=1, ylim=c(-1.5,1.5), clip=FALSE)
> plotmo(a$fit, ycolumn=2, ylim=c(-1.5,1.5), clip=FALSE)
> a <- update(a, nk=3) # not on man page
> print(a)
Call:
fda(formula = Species ~ ., data = iris, method = earth, keepxy = TRUE, 
    nk = 3)

Dimension: 2 

Percent Between-Group Variance Explained:
   v1    v2 
 94.4 100.0 

Training Misclassification Error: 0.04 ( N = 150 )
> print(summary(a$fit))
Call:
earth(x = x, y = Theta, weights = weights, keepxy = TRUE, nk = 3)

Response 1 expression:
  -1.3 
  + 1.35 * pmax(0, Petal.Width -         1.2) 
  +  2.6 * pmax(0,         1.2 - Petal.Width) 

Response 2 expression:
  -0.744 
  +  2.22 * pmax(0, Petal.Width -         1.2) 
  + 0.039 * pmax(0,         1.2 - Petal.Width) 

Number of cases: 300
Selected 3 of 3 terms, and 1 of 4 predictors
Number of terms at each degree of interaction: 1 2 (additive model)

Response 1  GCV: 0.119        RSS: 16.7         GRSq: 0.941      RSq: 0.944
Response 2  GCV: 0.243        RSS: 34.1         GRSq: 0.88       RSq: 0.886
All         GCV: 0.362        RSS: 50.7         GRSq: 0.869      RSq: 0.876
> 
> cat("--- format.earth.Rd ----------------------\n")
--- format.earth.Rd ----------------------
> as.func <- function( # convert expression string to func
+                object, digits = 8, use.names = TRUE, ...)
+   eval(parse(text=paste(
+     "function(x)\n",
+     "{\n",
+     "if(is.vector(x))\n",
+     "  x <- matrix(x, nrow = 1, ncol = length(x))\n",
+     "with(as.data.frame(x),\n",
+     format(object, digits = digits, use.names = use.names, ...),
+     ")\n",
+     "}\n", sep = "")))
> a <- earth(Volume ~ ., data = trees)
> my.func <- as.func(a, use.names = FALSE)
> print(my.func(c(10,80)))     # yields 17.76888
[1] 17.8
> print(predict(a, c(10,80)))  # yields 17.76888, but is slower
     [,1]
[1,] 17.8
> example(format.earth)

frmt.r> a <- earth(Volume ~ ., data = trees)

frmt.r> cat(format(a))
  26.6 
  +  6.05 * pmax(0,  Girth -   13.7) 
  -   3.2 * pmax(0,   13.7 -  Girth) 
  + 0.608 * pmax(0, Height -     75) 

frmt.r> # yields:
frmt.r> #    26.6 
frmt.r> #    +  6.05 * pmax(0,  Girth -   13.7) 
frmt.r> #    -   3.2 * pmax(0,   13.7 -  Girth) 
frmt.r> #    + 0.608 * pmax(0, Height -     75) 
frmt.r> 
frmt.r> cat(format(a, use.names = FALSE, add.labels = TRUE))
  26.6  # 1
  +  6.05 * pmax(0, x[,1] -  13.7)  # 2
  -   3.2 * pmax(0,  13.7 - x[,1])  # 3
  + 0.608 * pmax(0, x[,2] -    75)  # 4
> cat("--- get.nterms.per.degree.Rd ----------------------\n")
--- get.nterms.per.degree.Rd ----------------------
> example(get.nterms.per.degree)

gt.n..> data(ozone1)

gt.n..> a <- earth(O3 ~ ., data = ozone1, degree = 2)

gt.n..> get.nterms.per.degree(a)  # yields 1 6 7

0 1 2 
1 6 7 
> cat("--- get.nused.preds.per.subset.Rd ----------------------\n")
--- get.nused.preds.per.subset.Rd ----------------------
> example(get.nused.preds.per.subset)

gt....> data(ozone1)

gt....> a <- earth(O3 ~ ., data = ozone1, degree = 2)

gt....> get.nused.preds.per.subset(a$dirs, a$selected.terms)
[1] 8

gt....> # yields:
gt....> #    [1] 8     # there are 8 predictors in selected.terms
gt....> 
gt....> get.nused.preds.per.subset(a$dirs, a$prune.terms)
 [1] 0 1 2 3 4 5 5 6 6 8 8 8 8 8 8 8 8 8 8 8 8
> cat("--- mars.to.earth.Rd ----------------------\n")
--- mars.to.earth.Rd ----------------------
> example(mars.to.earth) # doesn't do anything
> library(mda)
> a <- mars(trees[,-3], trees[,3])
> a <- mars.to.earth(a)
> summary(a, digits = 2)
Call:
earth(x = trees[, -3], y = trees[, 3], minspan = 0)

Expression:
  20 
  +  5.4 * pmax(0,  Girth -     12) 
  -  2.6 * pmax(0,     12 -  Girth) 
  + 0.72 * pmax(0, Height -     76) 

Number of cases: 31
Selected 4 of 5 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 3 (additive model)
GCV: 13          RSS: 251         GRSq: 0.95      RSq: 0.97
> print(summary(a, digits=2))
Call:
earth(x = trees[, -3], y = trees[, 3], minspan = 0)

Expression:
  20 
  +  5.4 * pmax(0,  Girth -     12) 
  -  2.6 * pmax(0,     12 -  Girth) 
  + 0.72 * pmax(0, Height -     76) 

Number of cases: 31
Selected 4 of 5 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 3 (additive model)
GCV: 13          RSS: 251         GRSq: 0.95      RSq: 0.97
> cat("--- plot.earth.models.Rd ----------------------\n")
--- plot.earth.models.Rd ----------------------
> example(plot.earth.models)

plt.r.> data(ozone1)

plt.r.> a1 <- earth(O3 ~ ., data = ozone1, degree = 2, minspan = 0)

plt.r.> a2 <- earth(O3 ~ .-wind, data = ozone1, degree = 2, nk = 31, minspan = 0)

plt.r.> a3 <- earth(O3 ~ .-humidity, data = ozone1, degree = 2, nk = 31, minspan = 0)

plt.r.> plot.earth.models(list(a1,a2,a3), rlim=c(.6,.8))
> cat("--- plot.earth.Rd ----------------------\n")
--- plot.earth.Rd ----------------------
> example(plot.earth)

plt.rt> data(ozone1)

plt.rt> a <- earth(O3 ~ ., data = ozone1, degree = 2)

plt.rt> plot(a, col.npreds = 1, cum.grid = "none")
> cat("--- predict.earth.Rd ----------------------\n")
--- predict.earth.Rd ----------------------
> example(predict.earth)

prdct.> data(trees)

prdct.> a <- earth(Volume ~ ., data = trees)

prdct.> predict(a)           # same as a$fitted.values
    [,1]
1   9.35
2  10.31
3  10.95
4  16.39
5  20.68
6  22.22
7  17.99
8  17.99
9  21.35
10 18.63
11 21.39
12 19.88
13 19.88
14 20.23
15 21.20
16 24.08
17 30.16
18 32.05
19 26.64
20 27.25
21 30.28
22 32.70
23 31.48
24 40.55
25 43.58
26 52.06
27 53.88
28 55.09
29 55.69
30 55.69
31 75.67

prdct.> predict(a, c(10,80)) # yields 17.82973
     [,1]
[1,] 17.8
> cat("--- reorder.earth.Rd ----------------------\n")
--- reorder.earth.Rd ----------------------
> example(reorder.earth)

rrdr.r> data(ozone1)

rrdr.r> a <- earth(O3 ~ ., data = ozone1, degree = 2)

rrdr.r> reorder(a, decomp = "none")
 [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14

rrdr.r> # yields:
rrdr.r> # [1]  1  2  3  4  5  6  7  8  9 10 11 12 13 14
rrdr.r> 
rrdr.r> reorder(a)   # defaults to decomp = "anova"
 [1]  1 10  2  3  8  4  5 13 14  9  6  7 11 12

rrdr.r> # yields:
rrdr.r> # [1]  1 10  2  3  8  4  5 13 14  9  6  7 11 12
rrdr.r> 
rrdr.r> a$selected.terms[reorder(a)]
 [1]  1 16  2  4 13  6  7 20 21 14  9 10 18 19
> cat("--- update.earth.Rd ----------------------\n")
--- update.earth.Rd ----------------------
> example(update.earth)

updt.r> data(ozone1)

updt.r> (a <- earth(O3 ~ ., data = ozone1, degree = 2))
Selected 14 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 6 7
GCV: 13.7         RSS: 3663         GRSq: 0.786      RSq: 0.827

updt.r> # yields:
updt.r> #    Selected 14 of 21 terms, and 8 of 9 predictors
updt.r> #    Number of terms at each degree of interaction: 1 6 7
updt.r> #    GCV: 13.74837   RSS: 3662.576   GRSq: 0.7864352   RSq: 0.8265448
updt.r> 
updt.r> update(a, formula = O3 ~ . - temp) # requires forward pass and pruning
Selected 15 of 21 terms, and 8 of 8 predictors
Number of terms at each degree of interaction: 1 5 9
GCV: 13.1         RSS: 3435         GRSq: 0.796      RSq: 0.837

updt.r> # yields:
updt.r> #    Selected 15 of 21 terms, and 8 of 8 predictors
updt.r> #    Number of terms at each degree of interaction: 1 5 9
updt.r> #    GCV: 13.11272   RSS: 3434.579   GRSq: 0.7963093   RSq: 0.8373425
updt.r> 
updt.r> update(a, nprune = 8)              # requires only pruning
Selected 8 of 21 terms, and 6 of 9 predictors
Number of terms at each degree of interaction: 1 5 2
GCV: 15.9         RSS: 4674         GRSq: 0.753      RSq: 0.779
> 
> cat("--- test predict.earth -------------------\n")
--- test predict.earth -------------------
> a <- earth(Volume ~ ., data = trees)
> predict(a, c(10,80))
     [,1]
[1,] 17.8
> predict(a)
    [,1]
1   9.35
2  10.31
3  10.95
4  16.39
5  20.68
6  22.22
7  17.99
8  17.99
9  21.35
10 18.63
11 21.39
12 19.88
13 19.88
14 20.23
15 21.20
16 24.08
17 30.16
18 32.05
19 26.64
20 27.25
21 30.28
22 32.70
23 31.48
24 40.55
25 43.58
26 52.06
27 53.88
28 55.09
29 55.69
30 55.69
31 75.67
> xpredict <- matrix(c(10,12,80,90), nrow=2, ncol=2)
> predict(a, xpredict)
     [,1]
[1,] 17.8
[2,] 30.3
> colnames(xpredict) <- c("Girth", "Height")
> predict(a, xpredict)
     [,1]
[1,] 17.8
[2,] 30.3
> predict(a, as.data.frame(xpredict))
     [,1]
[1,] 17.8
[2,] 30.3
> # reverse dataframe columns (and their names), predict should deal with it correctly
> xpredict <- as.data.frame(cbind(xpredict[,2], xpredict[,1]))
> colnames(xpredict) <- c("Height", "Girth")
> predict(a, xpredict)
     [,1]
[1,] 17.8
[2,] 30.3
> # repeat but with x,y (not formula) call to earth
> x1 <- cbind(trees$Girth, trees$Height)
> colnames(x1) <- c("Girth", "Height")
> a <- earth(x1, trees$Volume)
> xpredict <- matrix(c(10,12,80,90), nrow=2, ncol=2)
> predict(a, xpredict)
     [,1]
[1,] 17.8
[2,] 30.3
> colnames(xpredict) <- c("Girth", "Height")
> predict(a, xpredict)
     [,1]
[1,] 17.8
[2,] 30.3
> predict(a, as.data.frame(xpredict))
     [,1]
[1,] 17.8
[2,] 30.3
> cat("--Expect warning from predict.earth: the variable names in 'data' do not match those in 'object'\n")
--Expect warning from predict.earth: the variable names in 'data' do not match those in 'object'
> xpredict <- as.data.frame(cbind(xpredict[,2], xpredict[,1]))
> colnames(xpredict) <- c("Height", "Girth")
> predict(a, xpredict)
     [,1]
[1,]  428
[2,]  488
Warning message:
the variable names in 'data' do not match those in 'object'
  data:        Height Girth
  object$dirs: Girth Height 
> 
> cat("--- test model building capabilities ----------------------\n")
--- test model building capabilities ----------------------
> itest <- 0
> N <- 100
> set.seed(1)
> x1 <- runif(N, -1, 1)
> x2 <- runif(N, -1, 1)
> x3 <- runif(N, -1, 1)
> x4 <- runif(N, -1, 1)
> x5 <- runif(N, -1, 1)
> x6 <- runif(N, -1, 1)
> x7 <- runif(N, -1, 1)
> x8 <- runif(N, -1, 1)
> x9 <- runif(N, -1, 1)
> x10 <- runif(N, -1, 1)
> 
> make.func <- function(
+     obj      = stop("no 'obj' arg"),
+     digits   = 14,
+     use.names = TRUE,   # use predictor names, else "x[,1]" etc
+     ...)                # extra args passed onto format, eg add.labels=TRUE
+ {
+     s <- paste(
+         "function(x)\n",
+         "{\n",
+         "if(is.vector(x))\n",
+         "  x <- matrix(x, nrow=1, ncol=length(x))\n",
+         "with(as.data.frame(x),\n",
+         format(obj, digits=digits, use.names=use.names, ...),
+         ")\n",
+         "}\n", sep="")
+ 
+     eval.parent(parse(text=s))
+ }
> 
> # this cross checks that RSq and GRSq claimed by
> # the model versus an independent calc of RSq and GRSq
> 
> test.model.rsq <- function(object, x, y, MarsFunc, nCases, nUsedTerms, penalty, RefFunc=NULL, ...)
+ {
+     y1 <- RefFunc(x, ...)
+     rss <- sum((y1 - MarsFunc(x))^2)
+     rss.null <- sum((y - mean(y))^2)
+     gcv.null <- earth:::get.gcv(rss.null, 1, penalty, nCases)
+     gcv <- earth:::get.gcv(rss, nUsedTerms, penalty, nCases)
+     if(is.finite(object$rsq))
+         if(!isTRUE(all.equal(object$rsq, 1 - rss/rss.null)))
+             cat("\nWarning: RSq mismatch object$rsq", object$rsq, "calculated RSq", 1 - rss/rss.null)
+         else if(!isTRUE(all.equal(object$grsq, 1 - gcv/gcv.null)))
+             cat("\nWarning GRSq mismatch object$grsq", object$grsq, "calculated GRSq", 1 - gcv/gcv.null)
+ }
> 
> # this uses the global matrix data.global (data.global[,1] is the response)
> 
> test.earth <- function(itest, func, degree=2, nk=51, plotit=plot.it.default, test.rsq=TRUE, trace=0)
+ {
+     cat("itest", sprintf("%-3d", itest), sprintf("%-32s", deparse(substitute(func))),
+         "degree", sprintf("%-2d", degree), "nk", sprintf("%-3g", nk))
+     if(trace)
+         cat("\n")
+     gc()
+     earthTime <- system.time(fite <- earth(data.global[,-1], data.global[,1],
+                                         degree=degree, trace=trace, nk=nk, pmethod="b", fast.k=-1))
+     funca <- make.func(fite)
+     nCases <- nrow(data.global)
+     penalty <- ifelse(degree>1,3,2)
+     nUsedTerms <- sum(fite$selected.terms!=0)
+     cat(" nTerms",  sprintf("%-2d", nUsedTerms), "of", sprintf("%-3d ", nrow(fite$dirs)))
+     if(print.time)
+         cat(" time", earthTime[1])
+     cat("GRSq", sprintf("%4.2g", fite$grsq))
+     caption <- paste("itest ", itest, ": ", deparse(substitute(func)),
+                         " degree=", degree, " nk=", nk, sep="")
+     if(test.rsq)
+         test.model.rsq(fite, x=data.global[,-1, drop=FALSE], y=data.global[,1], MarsFunc=funca,
+             nCases=nCases, nUsedTerms=nUsedTerms, penalty=penalty, RefFunc=func)
+     if(plotit) {
+         #$$ plotmo needs column names on x matrix wich are dropped if data.global[,-1] is a vector
+         if(!is.vector(data.global[,-1]))
+             plotmo(fite, func=func, caption=caption)
+         plot(fite, nresiduals=500, caption=caption)
+     }
+     cat("\n")
+     fite
+ }
> 
> ozone.test <- function(itest, sModel, x, y, degree=2, nk=51,
+                     plotit=plot.it.default, trace=0, col.loess="lightblue")
+ {
+     fite <- earth(x, y, degree=degree, nk=nk, trace=trace)
+     fitm <- mars(x, y, degree=degree, nk=nk)
+ 
+     cat("itest",
+         sprintf("%-3d", itest),
+         sprintf("%-32s", sModel),
+         "degree", sprintf("%-2d", degree), "nk", sprintf("%-3g", nk),
+         "nTerms",  sprintf("%-2d", sum(fite$selected.terms != 0)),
+         "of", sprintf("%-3d", nrow(fite$dirs)),
+         "GRSq", sprintf("%4.2g", fite$grsq),
+         "GRSq ratio", fite$grsq/mars.to.earth(fitm)$grsq,
+         "\n")
+     caption <- paste("itest ", itest, ": ", sModel, " degree=", degree, " nk=", nk, sep="")
+     if(plotit) {
+         fitme <- mars.to.earth(fitm)
+         plotmo(fite, caption=paste("EARTH", caption))
+         plotmo(fitme, caption=paste("MARS", caption))
+         plot(fite, nresiduals=500, col.loess=col.loess, caption=paste("EARTH", caption))
+         plot(fitme, caption=paste("MARS", caption))
+         fitme <- update(fitme)  # generate model selection data
+         plot.earth.models(list(fite, fitme), caption=paste(itest, ": Compare earth to mars ", sModel, sep=""))
+     }
+     fite
+ }
> 
> funcNoise <- function(x)    # noise
+ {
+     rnorm(1)
+ }
> x <- cbind(x1)
> data.global <- cbind(funcNoise(x), x1)
> # plotit=FALSE because there is only an intercept
> itest <- itest+1; test.earth(itest, funcNoise, nk=5,  degree=1, plotit=FALSE, test.rsq=FALSE)
itest 1   funcNoise                        degree 1  nk 5   nTerms 1  of 2   GRSq    0
Selected 1 of 2 terms, and 0 of 1 predictors
Number of terms at each degree of interaction: 1 (intercept only model)
GCV: 2.65e-34     RSS: 2.6e-32      GRSq: 0          RSq: 0  
> itest <- itest+1; test.earth(itest, funcNoise, nk=5,  degree=2, plotit=FALSE, test.rsq=FALSE)
itest 2   funcNoise                        degree 2  nk 5   nTerms 1  of 2   GRSq    0
Selected 1 of 2 terms, and 0 of 1 predictors
Number of terms at each degree of interaction: 1 (intercept only model)
GCV: 2.65e-34     RSS: 2.6e-32      GRSq: 0          RSq: 0  
> itest <- itest+1; test.earth(itest, funcNoise, nk=51, degree=1, plotit=FALSE, test.rsq=FALSE)
itest 3   funcNoise                        degree 1  nk 51  nTerms 1  of 2   GRSq    0
Selected 1 of 2 terms, and 0 of 1 predictors
Number of terms at each degree of interaction: 1 (intercept only model)
GCV: 2.65e-34     RSS: 2.6e-32      GRSq: 0          RSq: 0  
> itest <- itest+1; test.earth(itest, funcNoise, nk=51, degree=2, plotit=FALSE, test.rsq=FALSE)
itest 4   funcNoise                        degree 2  nk 51  nTerms 1  of 2   GRSq    0
Selected 1 of 2 terms, and 0 of 1 predictors
Number of terms at each degree of interaction: 1 (intercept only model)
GCV: 2.65e-34     RSS: 2.6e-32      GRSq: 0          RSq: 0  
> 
> func1 <- function(x)
+ {
+     sin(3 * x[,1]) + x[,2]
+ }
> x.global <- cbind(                    x1, x2)
> data.global <- cbind(func1(x.global), x1, x2)
> itest <- itest+1; test.earth(itest, func1, nk=5,   degree=1)
itest 5   func1                            degree 1  nk 5   nTerms 5  of 5   GRSq 0.86
Selected 5 of 5 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 4 (additive model)
GCV: 0.118        RSS: 9.76         GRSq: 0.86       RSq: 0.882
> itest <- itest+1; test.earth(itest, func1, nk=5,   degree=2)
itest 6   func1                            degree 2  nk 5   nTerms 5  of 5   GRSq 0.85
Selected 5 of 5 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 4 (additive model)
GCV: 0.123        RSS: 9.76         GRSq: 0.855      RSq: 0.882
> itest <- itest+1; test.earth(itest, func1, nk=51, degree=1)
itest 7   func1                            degree 1  nk 51  nTerms 8  of 8   GRSq    1
Selected 8 of 8 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 7 (additive model)
GCV: 0.00234      RSS: 0.169        GRSq: 0.997      RSq: 0.998
> itest <- itest+1; test.earth(itest, func1, nk=51, degree=2)
itest 8   func1                            degree 2  nk 51  nTerms 8  of 8   GRSq    1
Selected 8 of 8 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 7 (additive model)
GCV: 0.00255      RSS: 0.169        GRSq: 0.997      RSq: 0.998
> 
> func7 <- function(x)    # just one predictor
+ {
+     sin(5 * x[,1])
+ }
> x.global <- cbind(                    x1)
> data.global <- cbind(func7(x.global), x1)
> itest <- itest+1; test.earth(itest, func7, nk=5,  degree=1)
itest 9   func7                            degree 1  nk 5   nTerms 4  of 4   GRSq 0.77
Selected 4 of 4 terms, and 1 of 1 predictors
Number of terms at each degree of interaction: 1 3 (additive model)
GCV: 0.119        RSS: 10.3         GRSq: 0.768      RSq: 0.795
> itest <- itest+1; test.earth(itest, func7, nk=5,  degree=2)
itest 10  func7                            degree 2  nk 5   nTerms 4  of 4   GRSq 0.76
Selected 4 of 4 terms, and 1 of 1 predictors
Number of terms at each degree of interaction: 1 3 (additive model)
GCV: 0.123        RSS: 10.3         GRSq: 0.76       RSq: 0.795
> itest <- itest+1; test.earth(itest, func7, nk=51, degree=1)
itest 11  func7                            degree 1  nk 51  nTerms 8  of 8   GRSq 0.99
Selected 8 of 8 terms, and 1 of 1 predictors
Number of terms at each degree of interaction: 1 7 (additive model)
GCV: 0.00726      RSS: 0.525        GRSq: 0.986      RSq: 0.99
> itest <- itest+1; test.earth(itest, func7, nk=51, degree=2)
itest 12  func7                            degree 2  nk 51  nTerms 8  of 8   GRSq 0.98
Selected 8 of 8 terms, and 1 of 1 predictors
Number of terms at each degree of interaction: 1 7 (additive model)
GCV: 0.0079       RSS: 0.525        GRSq: 0.985      RSq: 0.99
> 
> func8 <- function(x)
+ {
+     ret <- 0
+     for (i in 1:5)
+         ret <- ret + sin(2 * x[,i])
+     ret + x[,1]*cos(4 * x[,2]) + (x[,3]-2)* x[,4]
+ }
> 
> func8noise <- function(x)
+ {
+     func8(x) + rnorm(nrow(x),0,1)
+ }
> 
> x.global <- cbind(                    x1,  x2,  x3,  x4,  x5)
> data.global <- cbind(func8(x.global), x1,  x2,  x3,  x4,  x5)
> itest <- itest+1; test.earth(itest, func8, nk=11, degree=1)
itest 13  func8                            degree 1  nk 11  nTerms 10 of 11  GRSq  0.9
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.298        RSS: 19.6         GRSq: 0.897      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8, nk=11, degree=2)
itest 14  func8                            degree 2  nk 11  nTerms 10 of 11  GRSq 0.88
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.335        RSS: 19.6         GRSq: 0.885      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8, nk=11, degree=10)
itest 15  func8                            degree 10 nk 11  nTerms 10 of 11  GRSq 0.88
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.335        RSS: 19.6         GRSq: 0.885      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8, nk=51, degree=1)
itest 16  func8                            degree 1  nk 51  nTerms 12 of 17  GRSq 0.92
Selected 12 of 17 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 11 (additive model)
GCV: 0.228        RSS: 13.5         GRSq: 0.922      RSq: 0.953
> itest <- itest+1; test.earth(itest, func8, nk=51, degree=2)
itest 17  func8                            degree 2  nk 51  nTerms 21 of 22  GRSq 0.98
Selected 21 of 22 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 14 6
GCV: 0.0597       RSS: 1.43         GRSq: 0.98       RSq: 0.995
> itest <- itest+1; test.earth(itest, func8, nk=51, degree=10)
itest 18  func8                            degree 10 nk 51  nTerms 21 of 22  GRSq 0.98
Selected 21 of 22 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 14 6
GCV: 0.0597       RSS: 1.43         GRSq: 0.98       RSq: 0.995
> itest <- itest+1; test.earth(itest, func8noise, nk=11, degree=1,  test.rsq=FALSE)
itest 19  func8noise                       degree 1  nk 11  nTerms 10 of 11  GRSq  0.9
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.298        RSS: 19.6         GRSq: 0.897      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8noise, nk=11, degree=2,  test.rsq=FALSE)
itest 20  func8noise                       degree 2  nk 11  nTerms 10 of 11  GRSq 0.88
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.335        RSS: 19.6         GRSq: 0.885      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8noise, nk=11, degree=10, test.rsq=FALSE)
itest 21  func8noise                       degree 10 nk 11  nTerms 10 of 11  GRSq 0.88
Selected 10 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.335        RSS: 19.6         GRSq: 0.885      RSq: 0.931
> itest <- itest+1; test.earth(itest, func8noise, nk=51, degree=1,  test.rsq=FALSE)
itest 22  func8noise                       degree 1  nk 51  nTerms 12 of 17  GRSq 0.92
Selected 12 of 17 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 11 (additive model)
GCV: 0.228        RSS: 13.5         GRSq: 0.922      RSq: 0.953
> itest <- itest+1; test.earth(itest, func8noise, nk=51, degree=2,  test.rsq=FALSE)
itest 23  func8noise                       degree 2  nk 51  nTerms 21 of 22  GRSq 0.98
Selected 21 of 22 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 14 6
GCV: 0.0597       RSS: 1.43         GRSq: 0.98       RSq: 0.995
> itest <- itest+1; test.earth(itest, func8noise, nk=51, degree=10, test.rsq=FALSE)
itest 24  func8noise                       degree 10 nk 51  nTerms 21 of 22  GRSq 0.98
Selected 21 of 22 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 14 6
GCV: 0.0597       RSS: 1.43         GRSq: 0.98       RSq: 0.995
> 
> eqn56 <- function(x) # Friedman MARS paper equation 56
+ {
+     0.1 * exp(4*x[,1]) +
+     4 / (1 + exp(-20*(x[,2]-0.5))) +
+     3 * x[,3] +
+     2 * x[,4] +
+     x[,5]
+ }
> 
> eqn56noise <- function(x)
+ {
+     eqn56(x) + rnorm(nrow(x),0,1)
+ }
> 
> neg.eqn56noise <- function(x)
+ {
+ -eqn56noise(x)
+ }
> 
> x.global <- cbind(                    x1, x2, x3, x4, x5, x6, x7, x8, x9, x10 )
> data.global <- cbind(eqn56(x.global), x1, x2, x3, x4, x5, x6, x7, x8, x9, x10 )
> itest <- itest+1; test.earth(itest, eqn56, nk=11, degree=1)
itest 25  eqn56                            degree 1  nk 11  nTerms 11 of 11  GRSq 0.96
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.333        RSS: 20.8         GRSq: 0.96       RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56, nk=11, degree=2)
itest 26  eqn56                            degree 2  nk 11  nTerms 11 of 11  GRSq 0.95
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.379        RSS: 20.8         GRSq: 0.955      RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56, nk=11, degree=10)
itest 27  eqn56                            degree 10 nk 11  nTerms 11 of 11  GRSq 0.95
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.379        RSS: 20.8         GRSq: 0.955      RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56, nk=51, degree=1)
itest 28  eqn56                            degree 1  nk 51  nTerms 13 of 14  GRSq    1
Selected 13 of 14 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 (additive model)
GCV: 0.0348       RSS: 1.96         GRSq: 0.996      RSq: 0.998
> itest <- itest+1; test.earth(itest, eqn56, nk=51, degree=2)
itest 29  eqn56                            degree 2  nk 51  nTerms 14 of 16  GRSq    1
Selected 14 of 16 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 1
GCV: 0.0205       RSS: 0.907        GRSq: 0.998      RSq: 0.999
> itest <- itest+1; test.earth(itest, eqn56, nk=51, degree=10)
itest 30  eqn56                            degree 10 nk 51  nTerms 14 of 16  GRSq    1
Selected 14 of 16 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 1
GCV: 0.0205       RSS: 0.907        GRSq: 0.998      RSq: 0.999
> itest <- itest+1; test.earth(itest, eqn56noise, nk=11, degree=1,  test.rsq=FALSE)
itest 31  eqn56noise                       degree 1  nk 11  nTerms 11 of 11  GRSq 0.96
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.333        RSS: 20.8         GRSq: 0.96       RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56noise, nk=11, degree=2,  test.rsq=FALSE)
itest 32  eqn56noise                       degree 2  nk 11  nTerms 11 of 11  GRSq 0.95
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.379        RSS: 20.8         GRSq: 0.955      RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56noise, nk=11, degree=10, test.rsq=FALSE)
itest 33  eqn56noise                       degree 10 nk 11  nTerms 11 of 11  GRSq 0.95
Selected 11 of 11 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 10 (additive model)
GCV: 0.379        RSS: 20.8         GRSq: 0.955      RSq: 0.975
> itest <- itest+1; test.earth(itest, eqn56noise, nk=51, degree=1,  test.rsq=FALSE)
itest 34  eqn56noise                       degree 1  nk 51  nTerms 13 of 14  GRSq    1
Selected 13 of 14 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 (additive model)
GCV: 0.0348       RSS: 1.96         GRSq: 0.996      RSq: 0.998
> itest <- itest+1; test.earth(itest, eqn56noise, nk=51, degree=2,  test.rsq=FALSE)
itest 35  eqn56noise                       degree 2  nk 51  nTerms 14 of 16  GRSq    1
Selected 14 of 16 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 1
GCV: 0.0205       RSS: 0.907        GRSq: 0.998      RSq: 0.999
> itest <- itest+1; test.earth(itest, eqn56noise, nk=51, degree=10, test.rsq=FALSE)
itest 36  eqn56noise                       degree 10 nk 51  nTerms 14 of 16  GRSq    1
Selected 14 of 16 terms, and 5 of 10 predictors
Number of terms at each degree of interaction: 1 12 1
GCV: 0.0205       RSS: 0.907        GRSq: 0.998      RSq: 0.999
> 
> robotArm <- function(x) # Friedman Fast MARS paper
+ {
+     l1     <- x[,1]
+     l2     <- x[,2]
+     theta1 <- x[,3]
+     theta2 <- x[,4]
+     phi    <- x[,5]
+ 
+     x1 <- l1 * cos(theta1) - l2 * cos(theta1 + theta2) * cos(phi)
+     y <-  l1 * sin(theta1) - l2 * sin(theta1 + theta2) * cos(phi)
+     z <-  l2 *  sin(theta2) * sin(phi)
+ 
+     sqrt(x1^2 + y^2 + z^2)
+ }
> N1 <- 100
> set.seed(1)
> x1. <- runif(N1, -1, 1)
> x2. <- runif(N1, -1, 1)
> x3. <- runif(N1, -1, 1)
> x4. <- runif(N1, -1, 1)
> x5. <- runif(N1, -1, 1)
> 
> x.global <- cbind(                       (x1.+1)/2, (x2.+2)/2, pi*(x3.+1), pi*(x4.+1), pi*x5./2 )
> data.global <- cbind(robotArm(x.global), (x1.+1)/2, (x2.+2)/2, pi*(x3.+1), pi*(x4.+1), pi*x5./2 )
> colnames(x.global) <- c("l1", "l2", "theta1", "theta2", "phi")
> colnames(data.global) <- c("arm", "l1", "l2", "theta1", "theta2", "phi")
> itest <- itest+1; test.earth(itest, robotArm, nk=51, degree=1)
itest 37  robotArm                         degree 1  nk 51  nTerms 10 of 23  GRSq  0.8
Selected 10 of 23 terms, and 4 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.0379       RSS: 2.49         GRSq: 0.797      RSq: 0.864
> itest <- itest+1; test.earth(itest, robotArm, nk=51, degree=10)
itest 38  robotArm                         degree 10 nk 51  nTerms 24 of 39  GRSq 0.88
Selected 24 of 39 terms, and 4 of 5 predictors
Number of terms at each degree of interaction: 1 9 9 5
GCV: 0.0223       RSS: 0.384        GRSq: 0.88       RSq: 0.98
> itest <- itest+1; test.earth(itest, robotArm, nk=201, degree=1)
itest 39  robotArm                         degree 1  nk 201 nTerms 10 of 23  GRSq  0.8
Selected 10 of 23 terms, and 4 of 5 predictors
Number of terms at each degree of interaction: 1 9 (additive model)
GCV: 0.0379       RSS: 2.49         GRSq: 0.797      RSq: 0.864
> itest <- itest+1; test.earth(itest, robotArm, nk=201, degree=10)
itest 40  robotArm                         degree 10 nk 201 nTerms 24 of 39  GRSq 0.88
Selected 24 of 39 terms, and 4 of 5 predictors
Number of terms at each degree of interaction: 1 9 9 5
GCV: 0.0223       RSS: 0.384        GRSq: 0.88       RSq: 0.98
> 
> cat("--- tests with ozone data ----------------------\n")
--- tests with ozone data ----------------------
> 
> data(ozone1)
> attach(ozone1)
> 
> x.global <- cbind(wind, humidity, temp, vis)
> y <- doy
> itest <- itest+1; ozone.test(itest, "doy ~ wind+humidity+temp+vis", x.global, y, degree=1, nk=21)
itest 41  doy ~ wind+humidity+temp+vis     degree 1  nk 21  nTerms 6  of 15  GRSq 0.18 GRSq ratio 1.36 
Selected 6 of 15 terms, and 3 of 4 predictors
Number of terms at each degree of interaction: 1 5 (additive model)
GCV: 8931         RSS: 2753871      GRSq: 0.183      RSq: 0.232
> 
> x.global <- cbind(wind, humidity, temp, vis)
> y <- doy
> itest <- itest+1; ozone.test(itest, "doy ~ wind+humidity+temp+vis", x.global, y, degree=2, nk=21)
itest 42  doy ~ wind+humidity+temp+vis     degree 2  nk 21  nTerms 8  of 20  GRSq 0.22 GRSq ratio 1.80 
Selected 8 of 20 terms, and 3 of 4 predictors
Number of terms at each degree of interaction: 1 2 5
GCV: 8511         RSS: 2502655      GRSq: 0.221      RSq: 0.302
> 
> # this is a basic test of RegressAndFix (because this generates lin dep bx cols)
> 
> cat("--Expect warning from mda::mars: NAs introduced by coercion\n") # why do we get a warning?
--Expect warning from mda::mars: NAs introduced by coercion
> x.global <- cbind(wind, exp(humidity))
> y <- doy
> # col.loess is 0 else get loess errors
> itest <- itest+1; ozone.test(itest, "doy ~ wind+exp(humidity)", x.global, y, degree=1, nk=21, col.loess=0)
itest 43  doy ~ wind+exp(humidity)         degree 1  nk 21  nTerms 3  of 5   GRSq  0.1 GRSq ratio 1.64 
Selected 3 of 5 terms, and 1 of 2 predictors
Number of terms at each degree of interaction: 1 2 (additive model)
GCV: 9825         RSS: 3144854      GRSq: 0.101      RSq: 0.123
Warning message:
NAs introduced by coercion in: as.integer.default(c(4, 3, 3, 4, 6, 3, 3, 3, 8, 3, 6, 6, 3, 2,  
> 
> x.global <- cbind(vh,wind,humidity,temp,ibh,dpg,ibt,vis,doy)
> y <- O3
> itest <- itest+1; ozone.test(itest, "O3~.", x.global, y, degree=2, nk=21)
itest 44  O3~.                             degree 2  nk 21  nTerms 14 of 21  GRSq 0.79 GRSq ratio 1.00 
Selected 14 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 6 7
GCV: 13.7         RSS: 3663         GRSq: 0.786      RSq: 0.827
> 
> x.global <- cbind(vh,wind,humidity,temp,ibh,dpg,ibt,vis,doy)
> y <- O3
> itest <- itest+1; ozone.test(itest, "O3~., nk=51", x.global, y, degree=2, nk=51)
itest 45  O3~., nk=51                      degree 2  nk 51  nTerms 22 of 49  GRSq 0.81 GRSq ratio 1.02 
Selected 22 of 49 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 3 18
GCV: 12.1         RSS: 2802         GRSq: 0.812      RSq: 0.867
> 
> detach(ozone1)
> options(options.old)
> 
> cat("--- fast mars -----------------------------------\n")
--- fast mars -----------------------------------
> 
> print(earth(O3 ~ ., data=ozone1, degree=2, nk = 31, fast.k = -1, fast.beta = 1))
Selected 15 of 31 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 2 12
GCV: 12.77556         RSS: 3346.267         GRSq: 0.8015467      RSq: 0.8415248
> print(earth(O3 ~ ., data=ozone1, degree=2, nk = 31, fast.k = -1, fast.beta = 0))
Selected 15 of 31 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 2 12
GCV: 12.77556         RSS: 3346.267         GRSq: 0.8015467      RSq: 0.8415248
> print(earth(O3 ~ ., data=ozone1, degree=2, nk = 31, fast.k = 5, fast.beta = 1))
Selected 15 of 31 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 5 9
GCV: 12.92977         RSS: 3386.659         GRSq: 0.7991513      RSq: 0.839612
> print(earth(O3 ~ ., data=ozone1, degree=2, nk = 31, fast.k = 5, fast.beta = 0))
Selected 14 of 31 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 4 9
GCV: 13.00762         RSS: 3465.24          GRSq: 0.7979419      RSq: 0.8358904
> 
> cat("--- plot.earth and plot.earth.models ------------\n")
--- plot.earth and plot.earth.models ------------
> 
> a <- earth(O3 ~ ., data=ozone1) # formula interface
> 
> plot(a, caption="plot.earth test 1", col.rsq=3, col.loess=4, col.qq="pink",
+     col.vline=1, col.npreds=0, nresiduals=100, cum.grid="grid")
> 
> set.seed(1)
> plot(a, caption="plot.earth test 2", which=c(3,4,1), rlim=c(.2,.9),
+     jitter=.01, id.n=5, legend.pos=c(10,.4), pch=20, lty.vline=1)
> 
> plot(a, caption="plot.earth test 3", which=c(2), main="test main")
> 
> a1 <- earth(ozone1[,c(2:4,10)], ozone1[,1])     # x,y interface
> 
> plot(a, caption="plot.earth test 4", id.n=1)
> 
> set.seed(1)
> plot.earth.models(a, which=1, rlim=c(.4,.8), jitter=.01)
> 
> plot.earth.models(a1)
> 
> plot.earth.models(list(a, a1), col.cum=c(3,4),  col.grsq=c(1,2), col.rsq=c(3,4),
+     col.npreds=1, col.vline=1, lty.vline=3,
+     legend.pos=c(5,.4), legend.text=c("a", "b", "c"))
> 
> cat("--- test min.span -------------------------------\n")
--- test min.span -------------------------------
> 
> a <- earth(O3 ~ ., data=ozone1, minspan=2)
> print(summary(a))
Call:
earth(formula = O3 ~ ., data = ozone1, minspan = 2)

Expression:
  12.57452 
  -  0.01650312 * pmax(0,     5740 -       vh) 
  -    0.334418 * pmax(0,     wind -        3) 
  -   0.1335317 * pmax(0,       54 - humidity) 
  +    0.319022 * pmax(0,     temp -       58) 
  - 0.004259428 * pmax(0,     1046 -      ibh) 
  -   0.1006914 * pmax(0,      dpg -       12) 
  +  0.03732186 * pmax(0,      ibt -      120) 
  +  0.04458249 * pmax(0,       80 -      vis) 
  +   0.0419109 * pmax(0,      doy -       89) 
  -   0.1151491 * pmax(0,       89 -      doy) 
  -  0.08338937 * pmax(0,      doy -      159) 

Number of cases: 330
Selected 12 of 20 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 11 (additive model)
GCV: 14.68372         RSS: 4193.714         GRSq: 0.7719057      RSq: 0.8013908
> 
> a <- earth(O3 ~ ., data=ozone1, minspan=0)
> print(summary(a))
Call:
earth(formula = O3 ~ ., data = ozone1, minspan = 0)

Expression:
  13.99702 
  -  0.01377662 * pmax(0,     5860 -       vh) 
  -   0.3449381 * pmax(0,     wind -        3) 
  -   0.1312961 * pmax(0,       55 - humidity) 
  +   0.2781026 * pmax(0,     temp -       58) 
  - 0.003301034 * pmax(0,     1108 -      ibh) 
  -  0.09980877 * pmax(0,      dpg -       10) 
  +  0.03250189 * pmax(0,      ibt -      121) 
  +  0.02321548 * pmax(0,      150 -      vis) 
  +  0.04134396 * pmax(0,      doy -       92) 
  -   0.1168261 * pmax(0,       92 -      doy) 
  -  0.08479972 * pmax(0,      doy -      159) 

Number of cases: 330
Selected 12 of 20 terms, and 9 of 9 predictors
Number of terms at each degree of interaction: 1 11 (additive model)
GCV: 14.58982         RSS: 4166.897         GRSq: 0.7733643      RSq: 0.8026608
> 
> cat("--- test multiple responses ---------------------\n")
--- test multiple responses ---------------------
> 
> # this uses the global matrix data.global (data.global[,1:2] is the response)
> 
> test.earth.two.responses <- function(itest, func1, func2,
+     degree=2, nk=51, plotit=plot.it.default, test.rsq=TRUE, trace=0, minspan=1)
+ {
+     if(typeof(func1) == "character")
+         funcnames <- paste("multiple responses", func1, func2)
+     else
+         funcnames <- paste("multiple responses", deparse(substitute(func1)), deparse(substitute(func2)))
+     cat("itest", sprintf("%-3d", itest), funcnames,
+         " degree", sprintf("%-2d", degree), "nk", sprintf("%-3g", nk), "\n\n")
+     gc()
+     fite <- earth(data.global[,c(-1,-2), drop=FALSE], data.global[,1:2],
+                 degree=degree, trace=trace, nk=nk, pmethod="b", fast.k=-1, minspan=minspan)
+     print(fite)
+     caption <- paste("itest ", itest, ": ", funcnames, " degree=", degree, " nk=", nk, sep="")
+     if(plotit) {
+         if(typeof(func1) == "character") {
+             plotmo(fite, caption=caption)
+             plotmo(fite, ycolumn=2)
+         } else {
+             plotmo(fite, func=func1, caption=caption)
+             plotmo(fite, func=func2, ycolumn=2)
+         }
+         plot(fite, caption=caption)
+         plot(fite, ycolumn=2)
+     }
+     cat("\n")
+     fite
+ }
> 
> x.global <- cbind(                                     x1, x2)
> data.global <- cbind(func1(x.global), func7(x.global), x1, x2)
> itest <- itest+1; a <- test.earth.two.responses(itest, func1, func7, nk=51, degree=1)
itest 46  multiple responses func1 func7  degree 1  nk 51  

Selected 9 of 9 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 0.001929126      RSS: 0.1328975        GRSq: 0.9985979      RSq: 0.9990145
Response 2  GCV: 0.00830622       RSS: 0.5722154        GRSq: 0.9939628      RSq: 0.9957566
All         GCV: 0.01023535       RSS: 0.705113         GRSq: 0.9975333      RSq: 0.9982662

> print(summary(a))
Call:
earth(x = data.global[, c(-1, -2), drop = FALSE], y = data.global[, 
    1:2], trace = trace, degree = degree, nk = nk, minspan = minspan, 
    fast.k = -1, pmethod = "b")

Response 1 expression:
  -1.424429 
  +  1.641520 * pmax(0,         x1 - -0.4839664) 
  +  1.472156 * pmax(0, -0.4839664 -         x1) 
  -  1.784302 * pmax(0,         x1 -  0.4222424) 
  +  1.145794 * pmax(0,         x1 - -0.2557522) 
  -  1.140449 * pmax(0,         x1 -  0.2582281) 
  -  2.249128 * pmax(0,         x1 -  0.6788807) 
  + 0.9875745 * pmax(0,         x2 - -0.3424454) 
  -  1.024736 * pmax(0, -0.3424454 -         x2) 

Response 2 expression:
  -0.6135155 
  -   2.015647 * pmax(0,         x1 - -0.4839664) 
  +   3.948503 * pmax(0, -0.4839664 -         x1) 
  -   4.101431 * pmax(0,         x1 -  0.4222424) 
  +   6.150471 * pmax(0,         x1 - -0.2557522) 
  -   4.795015 * pmax(0,         x1 -  0.2582281) 
  +   1.689150 * pmax(0,         x1 -  0.6788807) 
  - 0.02189608 * pmax(0,         x2 - -0.3424454) 
  + 0.02422471 * pmax(0, -0.3424454 -         x2) 

Number of cases: 200
Selected 9 of 9 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 0.001929126      RSS: 0.1328975        GRSq: 0.9985979      RSq: 0.9990145
Response 2  GCV: 0.00830622       RSS: 0.5722154        GRSq: 0.9939628      RSq: 0.9957566
All         GCV: 0.01023535       RSS: 0.705113         GRSq: 0.9975333      RSq: 0.9982662
> plotmo(a, ycolumn=1)     # test generation of caption based on response name
> plotmo(a, ycolumn=2)
> plot(a, ycolumn=1)
> plot(a, ycolumn=2)
> 
> x.global <- cbind(                                     x1, x2)
> data.global <- cbind(func1(x.global), func7(x.global), x1, x2)
> itest <- itest+1; a <- test.earth.two.responses(itest, func1, func7, nk=51, degree=3)
itest 47  multiple responses func1 func7  degree 3  nk 51  

Selected 9 of 9 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 0.002129427      RSS: 0.1328975        GRSq: 0.9984523      RSq: 0.9990145
Response 2  GCV: 0.00916865       RSS: 0.5722154        GRSq: 0.993336       RSq: 0.9957566
All         GCV: 0.01129808       RSS: 0.705113         GRSq: 0.9972772      RSq: 0.9982662

> print(summary(a))
Call:
earth(x = data.global[, c(-1, -2), drop = FALSE], y = data.global[, 
    1:2], trace = trace, degree = degree, nk = nk, minspan = minspan, 
    fast.k = -1, pmethod = "b")

Response 1 expression:
  -1.424429 
  +  1.641520 * pmax(0,         x1 - -0.4839664) 
  +  1.472156 * pmax(0, -0.4839664 -         x1) 
  -  1.784302 * pmax(0,         x1 -  0.4222424) 
  +  1.145794 * pmax(0,         x1 - -0.2557522) 
  -  1.140449 * pmax(0,         x1 -  0.2582281) 
  -  2.249128 * pmax(0,         x1 -  0.6788807) 
  + 0.9875745 * pmax(0,         x2 - -0.3424454) 
  -  1.024736 * pmax(0, -0.3424454 -         x2) 

Response 2 expression:
  -0.6135155 
  -   2.015647 * pmax(0,         x1 - -0.4839664) 
  +   3.948503 * pmax(0, -0.4839664 -         x1) 
  -   4.101431 * pmax(0,         x1 -  0.4222424) 
  +   6.150471 * pmax(0,         x1 - -0.2557522) 
  -   4.795015 * pmax(0,         x1 -  0.2582281) 
  +   1.689150 * pmax(0,         x1 -  0.6788807) 
  - 0.02189608 * pmax(0,         x2 - -0.3424454) 
  + 0.02422471 * pmax(0, -0.3424454 -         x2) 

Number of cases: 200
Selected 9 of 9 terms, and 2 of 2 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 0.002129427      RSS: 0.1328975        GRSq: 0.9984523      RSq: 0.9990145
Response 2  GCV: 0.00916865       RSS: 0.5722154        GRSq: 0.993336       RSq: 0.9957566
All         GCV: 0.01129808       RSS: 0.705113         GRSq: 0.9972772      RSq: 0.9982662
> 
> x.global <- cbind(                                           x1, x2, x3, x4, x5)
> data.global <- cbind(eqn56(x.global), neg.eqn56noise(x.global), x1, x2, x3, x4, x5)
> itest <- itest+1; a <- test.earth.two.responses(itest, eqn56, neg.eqn56noise, nk=51, degree=1)
itest 48  multiple responses eqn56 neg.eqn56noise  degree 1  nk 51  

Selected 13 of 15 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 12 (additive model)

Response 1  GCV: 0.0593368        RSS: 3.337695         GRSq: 0.9976027      RSq: 0.9986241
Response 2  GCV: 1.086576         RSS: 61.1199          GRSq: 0.9561008      RSq: 0.9748053
All         GCV: 1.070004         RSS: 60.1877          GRSq: 0.9308328      RSq: 0.9603035

> 
> x.global <- cbind(                                           x1, x2, x3, x4, x5)
> data.global <- cbind(eqn56(x.global), neg.eqn56noise(x.global), x1, x2, x3, x4, x5)
> itest <- itest+1; a <- test.earth.two.responses(itest, eqn56, neg.eqn56noise, nk=51, degree=2)
itest 49  multiple responses eqn56 neg.eqn56noise  degree 2  nk 51  

Selected 11 of 39 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 7 3

Response 1  GCV: 0.4014800        RSS: 21.98505         GRSq: 0.9830061      RSq: 0.9905052
Response 2  GCV: 2.461022         RSS: 134.7656         GRSq: 0.8958297      RSq: 0.9417981
All         GCV: 2.672652         RSS: 146.3544         GRSq: 0.8305453      RSq: 0.9053225

> 
> N1 <- 100
> set.seed(1)
> x1. <- runif(N1, -1, 1)
> x2. <- runif(N1, -1, 1)
> x3. <- runif(N1, -1, 1)
> x4. <- runif(N1, -1, 1)
> x5. <- runif(N1, -1, 1)
> 
> x.global <- cbind(                                        (x1.+1)/2, (x2.+2)/2, pi*(x3.+1), pi*(x4.+1), pi*x5./2 )
> data.global <- cbind(robotArm(x.global), eqn56(x.global), (x1.+1)/2, (x2.+2)/2, pi*(x3.+1), pi*(x4.+1), pi*x5./2 )
> colnames(x.global)    <- c(                "l1", "l2", "theta1", "theta2", "phi")
> colnames(data.global) <- c("arm", "eqn56", "l1", "l2", "theta1", "theta2", "phi")
> itest <- itest+1; test.earth.two.responses(itest, robotArm, eqn56, nk=51, degree=1)
itest 50  multiple responses robotArm eqn56  degree 1  nk 51  

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.06299932       RSS: 3.931788         GRSq: 0.9998451      RSq: 0.9999014
Response 2  GCV: 0.03918599       RSS: 2.445597         GRSq: 0.9999037      RSq: 0.9999387
All         GCV: 0.1021853        RSS: 6.377385         GRSq: 0.9951406      RSq: 0.9969057

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.06299932       RSS: 3.931788         GRSq: 0.9998451      RSq: 0.9999014
Response 2  GCV: 0.03918599       RSS: 2.445597         GRSq: 0.9999037      RSq: 0.9999387
All         GCV: 0.1021853        RSS: 6.377385         GRSq: 0.9951406      RSq: 0.9969057
> itest <- itest+1; test.earth.two.responses(itest, robotArm, eqn56, nk=51, degree=10)
itest 51  multiple responses robotArm eqn56  degree 10 nk 51  

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057
> itest <- itest+1; test.earth.two.responses(itest, robotArm, eqn56, nk=201, degree=1)
itest 52  multiple responses robotArm eqn56  degree 1  nk 201 

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.06299932       RSS: 3.931788         GRSq: 0.9998451      RSq: 0.9999014
Response 2  GCV: 0.03918599       RSS: 2.445597         GRSq: 0.9999037      RSq: 0.9999387
All         GCV: 0.1021853        RSS: 6.377385         GRSq: 0.9951406      RSq: 0.9969057

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.06299932       RSS: 3.931788         GRSq: 0.9998451      RSq: 0.9999014
Response 2  GCV: 0.03918599       RSS: 2.445597         GRSq: 0.9999037      RSq: 0.9999387
All         GCV: 0.1021853        RSS: 6.377385         GRSq: 0.9951406      RSq: 0.9969057
> itest <- itest+1; test.earth.two.responses(itest, robotArm, eqn56, nk=201, degree=2)
itest 53  multiple responses robotArm eqn56  degree 2  nk 201 

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057
> itest <- itest+1; test.earth.two.responses(itest, robotArm, eqn56, nk=201, degree=10)
itest 54  multiple responses robotArm eqn56  degree 10 nk 201 

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057

Selected 11 of 11 terms, and 5 of 5 predictors
Number of terms at each degree of interaction: 1 10 (additive model)

Response 1  GCV: 0.07180036       RSS: 3.931788         GRSq: 0.9998235      RSq: 0.9999014
Response 2  GCV: 0.04466029       RSS: 2.445597         GRSq: 0.9998902      RSq: 0.9999387
All         GCV: 0.1164606        RSS: 6.377385         GRSq: 0.9944618      RSq: 0.9969057
> 
> attach(ozone1)
> x.global <- cbind(                wind, humidity, temp, ibh, dpg, ibt, vis)
> data.global <- cbind(O3, doy, vh, wind, humidity, temp, ibh, dpg, ibt, vis)
> itest <- itest+1; test.earth.two.responses(itest, "O3", "doy", nk=51, degree=2, minspan=0)
itest 55  multiple responses O3 doy  degree 2  nk 51  

Selected 9 of 49 terms, and 6 of 8 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 30.97042         RSS: 8960.868         GRSq: 0.9993842      RSq: 0.9994568
Response 2  GCV: 9924.336         RSS: 2871471          GRSq: 0.8026762      RSq: 0.8259378
All         GCV: 9903.202         RSS: 2865357          GRSq: 0.840334       RSq: 0.8591563

Selected 9 of 49 terms, and 6 of 8 predictors
Number of terms at each degree of interaction: 1 8 (additive model)

Response 1  GCV: 30.97042         RSS: 8960.868         GRSq: 0.9993842      RSq: 0.9994568
Response 2  GCV: 9924.336         RSS: 2871471          GRSq: 0.8026762      RSq: 0.8259378
All         GCV: 9903.202         RSS: 2865357          GRSq: 0.840334       RSq: 0.8591563
> detach(ozone1)
> 
> cat("--- formula based multiple response -------------\n")
--- formula based multiple response -------------
> 
> a2 <- earth(cbind(O3,doy) ~ ., data=ozone1, degree=2)
> plotmo(a2)                  # test generation of caption based on response name
> plotmo(a2, ycolumn=1)
> plotmo(a2, ycolumn=2)
> plot(a2)
> plot(a2, ycolumn=1)
> plot(a2, ycolumn=2)
> 
> cat("--- test plot.earth.models with multiple responses ---\n")
--- test plot.earth.models with multiple responses ---
> 
> a <- earth(O3 ~ ., data=ozone1, degree=2)
> a2 <- earth(cbind(O3,doy) ~ ., data=ozone1, degree=2)
> b2 <- earth(cbind(O3,doy) ~ ., data=ozone1, degree=1)
> plot.earth.models(list(a, a2), caption="plot.earth.models with multiple responses, list(a,a2)")
> plot.earth.models(list(a2, a), caption="plot.earth.models with multiple responses, list(a2,a)")
> plot.earth.models(list(a2, b2), caption="plot.earth.models with multiple responses, list(a2,b2)")
> 
> cat("--- subset --------------------------------------\n")
--- subset --------------------------------------
> 
> set.seed(9)
> train.subset <- sample(1:nrow(ozone1), .8 * nrow(ozone1))
> test.subset <- (1:nrow(ozone1))[-train.subset]
> 
> # all the following models should be identical
> a <- earth(ozone1[,-1], ozone1[,1], subset=train.subset, nprune=7, degree=2)
> print(a)
Selected 7 of 21 terms, and 5 of 9 predictors
Number of terms at each degree of interaction: 1 4 2
GCV: 15.85857         RSS: 3694.567         GRSq: 0.7521273      RSq: 0.7795955
> plotmo(a, caption="test subset: earth(ozone1[,-1], ozone1[,1], subset=train.subset)")
> 
> a <- earth(ozone1[train.subset,-1], ozone1[train.subset,1], nprune=7, degree=2)
> print(a)
Selected 7 of 21 terms, and 5 of 9 predictors
Number of terms at each degree of interaction: 1 4 2
GCV: 15.85857         RSS: 3694.567         GRSq: 0.7521273      RSq: 0.7795955
> plotmo(a, caption="test subset: earth(ozone1[train.subset,-1], ozone1[train.subset,1]")
> 
> a <- earth(O3 ~ ., data=ozone1, subset=train.subset, nprune=7, degree=2)
> print(a)
Selected 7 of 21 terms, and 5 of 9 predictors
Number of terms at each degree of interaction: 1 4 2
GCV: 15.85857         RSS: 3694.567         GRSq: 0.7521273      RSq: 0.7795955
> plotmo(a, caption="test subset: earth(O3 ~ ., data=ozone1, subset=train.subset")
> 
> y <- ozone1[test.subset, 1]
> yhat <- predict(a, newdata = ozone1[test.subset, -1])
> print(1 - sum((y - yhat)^2)/sum((y - mean(y))^2)) # print RSquared
[1] 0.7689271
> 
> cat("--- ppenalty and update -------------------------\n")
--- ppenalty and update -------------------------
> 
> a <- earth(O3 ~ ., data=ozone1, degree=2)
> print(update(a, ppenalty = -1))
Selected 21 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 10 10
GCV: 10.69193         RSS: 3528.338         GRSq: 0.8329022      RSq: 0.8329022
> print(update(a, ppenalty = 10))
Selected 10 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 6 3
GCV: 17.88255         RSS: 4098.084         GRSq: 0.7222156      RSq: 0.8059197
> a <- earth(O3 ~ ., data=ozone1, nk=31, pmethod="n", degree=2)
> a.none <- print(update(a, nprune=10, pmethod="n"))
Selected 10 of 31 terms, and 5 of 9 predictors
Number of terms at each degree of interaction: 1 6 3
GCV: 14.64043         RSS: 4167.744         GRSq: 0.772578       RSq: 0.8026207
> print(update(a.none, pmethod="b"))
Selected 10 of 31 terms, and 7 of 9 predictors
Number of terms at each degree of interaction: 1 2 7
GCV: 14.64043         RSS: 4167.744         GRSq: 0.772578       RSq: 0.8026207
> print(update(a.none, nprune=4, pmethod="e"))
Selected 4 of 31 terms, and 3 of 9 predictors
Number of terms at each degree of interaction: 1 2 1
GCV: 18.57966         RSS: 5819.501         GRSq: 0.7113868      RSq: 0.7243955
> a.updated <- update(a.none, nprune=10, pmethod="b")
> print(a.updated)
Selected 10 of 31 terms, and 7 of 9 predictors
Number of terms at each degree of interaction: 1 2 7
GCV: 14.64043         RSS: 4167.744         GRSq: 0.772578       RSq: 0.8026207
> a.backwards <- update(a, nprune=10, pmethod="b")
> print(a.backwards)
Selected 10 of 31 terms, and 7 of 9 predictors
Number of terms at each degree of interaction: 1 2 7
GCV: 14.64043         RSS: 4167.744         GRSq: 0.772578       RSq: 0.8026207
> print(all.equal(a.updated$bx, a.backwards$bx))
[1] TRUE
> a <- earth(O3 ~ ., data=ozone1, nk=31, nprune=10, pmethod="b", degree=2)
> print(a)
Selected 10 of 31 terms, and 7 of 9 predictors
Number of terms at each degree of interaction: 1 2 7
GCV: 14.64043         RSS: 4167.744         GRSq: 0.772578       RSq: 0.8026207
> print(all.equal(a$bx, a.backwards$bx))
[1] TRUE
> 
> cat("--- Force.xtx.prune -----------------------------\n")
--- Force.xtx.prune -----------------------------
> 
> a <- earth(Volume ~ ., data = trees)
> a1 <- earth(Volume ~ ., data = trees, Force.xtx.prune=TRUE)
> print(all.equal(a$bx, a1$bx))
[1] TRUE
> 
> a <- earth(O3 ~ ., data = ozone1, nk=51)
> a1 <- earth(O3 ~ ., data = ozone1, nk=51, Force.xtx.prune=TRUE)
> print(all.equal(a$bx, a1$bx))
[1] TRUE
> 
> cat("--- extractAIC.earth ----------------------------\n")
--- extractAIC.earth ----------------------------
> 
> a <-earth(O3 ~ ., data=ozone1, degree=2)
> cat("Ignore 10 warnings: extractAIC.earth: using GCV instead of AIC\n")
Ignore 10 warnings: extractAIC.earth: using GCV instead of AIC
> print(drop1(a))
Single term deletions

Model:
O3 ~ vh + wind + humidity + temp + ibh + dpg + ibt + vis + doy
           Df    AIC
<none>        13.748
vh        5.0 13.614
wind      5.0 13.910
humidity -2.5 15.044
temp     -2.5 13.113
ibh       7.5 12.904
dpg       7.5 14.511
ibt       0.0 13.748
vis      -5.0 13.929
doy      10.0 15.331
Warning messages:
1: extractAIC.earth: returning GCV instead of AIC 
2: extractAIC.earth: returning GCV instead of AIC 
3: extractAIC.earth: returning GCV instead of AIC 
4: extractAIC.earth: returning GCV instead of AIC 
5: extractAIC.earth: returning GCV instead of AIC 
6: extractAIC.earth: returning GCV instead of AIC 
7: extractAIC.earth: returning GCV instead of AIC 
8: extractAIC.earth: returning GCV instead of AIC 
9: extractAIC.earth: returning GCV instead of AIC 
10: extractAIC.earth: returning GCV instead of AIC 
> 
> cat("--- fda and mda with earth -----------------------------------\n")
--- fda and mda with earth -----------------------------------
> 
> am <- fda(Species ~ ., data=iris, method=mars, degree=1, keepxy=TRUE)
> print(am)
Call:
fda(formula = Species ~ ., data = iris, method = mars, degree = 1, 
    keepxy = TRUE)

Dimension: 2 

Percent Between-Group Variance Explained:
    v1     v2 
 95.31 100.00 

Training Misclassification Error: 0.02 ( N = 150 )
> a <- fda(Species ~ ., data=iris, method=earth, degree=1, keepxy=TRUE)
> print(a)
Call:
fda(formula = Species ~ ., data = iris, method = earth, degree = 1, 
    keepxy = TRUE)

Dimension: 2 

Percent Between-Group Variance Explained:
    v1     v2 
 92.69 100.00 

Training Misclassification Error: 0.03333 ( N = 150 )
> print(confusion(a))
            true
object       setosa versicolor virginica
  setosa         50          0         0
  versicolor      0         48         3
  virginica       0          2        47
attr(,"error")
[1] 0.03333333
> par(mar=c(3, 3, 2, .5))  # small margins and text to pack figs in
> par(mgp=c(1.6, 0.6, 0))  # flatten axis elements
> par(oma=c(0,0,4,0))      # make space for caption
> layout(rbind(c(1,1,0,0), c(2,3,4,5), c(6,7,8,9)), heights=c(2,1,1))
> plot(a)
> plotmo(a$fit, ycolum=1, ylim=c(-1.5,1.5), clip=FALSE, do.par=FALSE)
> plotmo(a$fit, ycolum=2, ylim=c(-1.5,1.5), clip=FALSE, do.par=FALSE)
> mtext("fda test", outer=TRUE, font=2, line=1.5, cex=1)
> 
> data(glass)
> set.seed(123)
> samp <- sample(c(1:214), size=100, replace=FALSE)
> glass.train <- glass[samp,]
> glass.test <- glass[-samp,]
> am <- mda(Type ~ ., data=glass.train, method=mars,  keepxy=TRUE, degree=2)
> a <-  mda(Type ~ ., data=glass.train, method=earth, keepxy=TRUE, degree=2)
> print(am)
Call:
mda(formula = Type ~ ., data = glass.train, method = mars, keepxy = TRUE, 
    degree = 2)

Dimension: 9 

Percent Between-Group Variance Explained:
    v1     v2     v3     v4     v5     v6     v7     v8     v9 
 44.62  75.74  84.36  91.27  95.96  98.38  99.40 100.00 100.00 

Training Misclassification Error: 0.32 ( N = 100 )

Deviance: 151.375 
> print(a)
Call:
mda(formula = Type ~ ., data = glass.train, method = earth, keepxy = TRUE, 
    degree = 2)

Dimension: 17 

Percent Between-Group Variance Explained:
    v1     v2     v3     v4     v5     v6     v7     v8     v9    v10    v11 
 75.87  87.84  96.00  97.59  98.36  98.86  99.28  99.56  99.77  99.92  99.96 
   v12    v13    v14    v15    v16    v17 
 99.99 100.00 100.00 100.00 100.00 100.00 

Training Misclassification Error: 0.14 ( N = 100 )

Deviance: 78.969 
> cat("mda with mars  ", attr(confusion(am), "error"), "\n")
mda with mars   0.32 
> cat("mda with earth ", attr(confusion(a),  "error"), "\n")
mda with earth  0.14 
> plotmo(a$fit, ycolum=9, clip=FALSE)
> 
> cat("--- ../../tests/test.earth.R -------------------------\n")
--- ../../tests/test.earth.R -------------------------
> 
> source("../../tests/test.earth.R")
Call: earth.default(x=x,y=y,trace=4,degree=2) 

Forward pass: model matrix 330 x 9 y 330 x 1 minspan 1 endspan 15

         GRSq    RSq     DeltaRSq       RSS Pred PredName         Cut  Terms   Parents
1      0.0000 0.0000              2.112e+04                            1
2      0.6493 0.6599       0.6599   7181.92    4     temp          58  2   3   
4      0.6914 0.7099      0.05004   6125.24    5      ibh        1023  4   5   
6      0.7115 0.7372       0.0273   5548.77    9      doy          89  6   7   
8      0.7302 0.7620      0.02482   5024.59    3 humidity          54  8   9   2   
10     0.7546 0.7905      0.02847   4423.53    6      dpg          54  10  11  2   
12     0.7598 0.8016      0.01109   4189.41    8      vis         200  12  13  
14     0.7638 0.8114     0.009793   3982.63    2     wind           7  14  15  5   
16     0.7649 0.8186     0.007174   3831.14    1       vh        5550  16  17  
18     0.7666 0.8261     0.007497   3672.84    6      dpg          -4  18  19  13  
20     0.7676 0.8329     0.006843   3528.34    9      doy         151  20  21  16  

GRSq: 0.7676 RSq: 0.8329
Reached max number of terms 21
Forward pass complete: 21 terms

Subset size         GCV         GRSq      RSq  nPreds  Terms (index into bx)
          1     64.3756       0.0000   0.0000       0  1
          2     23.1254       0.6408   0.6462       1  1 2
          3     19.9058       0.6908   0.7001       2  1 2 4
          4     18.5797       0.7114   0.7244       3  1 2 4 9
          5     18.0541       0.7196   0.7363       4  1 2 4 9 10
          6      17.584       0.7269   0.7472       5  1 2 4 9 10 13
          7     16.7935       0.7391   0.7624       5  1 2 4 6 7 9 10
          8     15.8959       0.7531   0.7786       6  1 2 4 6 7 9 10 13
          9      15.183       0.7642   0.7920       6  1 2 9 13 16 18 19 20 21
         10     14.3957       0.7764   0.8059       8  1 2 4 6 7 9 10 13 14 16
         11     14.2025       0.7794   0.8116       8  1 2 4 6 7 9 10 11 13 14 16
         12     13.8257       0.7852   0.8196       8  1 2 4 6 7 9 10 13 14 16 18 19
         13     13.8336       0.7851   0.8225       8  1 2 4 6 9 10 13 14 16 18 19 20 21
chosen   14     13.7484       0.7864   0.8265       8  1 2 4 6 7 9 10 13 14 16 18 19 20 21
         15     13.8215       0.7853   0.8286       8  1 2 4 6 7 9 10 11 13 14 16 18 19 20 21
         16     13.9162       0.7838   0.8303       8  1 2 4 5 6 7 9 10 11 13 14 16 18 19 20 21
         17     14.0667       0.7815   0.8314       8  1 2 4 5 6 7 8 9 10 11 13 14 16 18 19 20 21
         18     14.2532       0.7786   0.8321       8  1 2 3 4 5 6 7 8 9 10 11 13 14 16 18 19 20 21
         19     14.4438       0.7756   0.8328       8  1 2 3 4 5 6 7 8 9 10 11 12 13 14 16 18 19 20 21
         20     14.6939       0.7717   0.8329       8  1 2 3 4 5 6 7 8 9 10 11 12 13 14 16 17 18 19 20 21
         21     14.9581       0.7676   0.8329       8  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21

Prune method "backward" ppenalty 3 nprune 21: selected 14 of 21 terms, and 8 of 9 predictors
GRSq: 0.7864 RSq: 0.8265 
Selected 14 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 6 7
GCV: 13.7         RSS: 3663         GRSq: 0.786      RSq: 0.827
Call:
earth(formula = O3 ~ ., data = ozone1, degree = 2, trace = 4)

Expression:
  6.14 
  +   0.0361 * pmax(0,       vh -     5550) 
  +    0.356 * pmax(0,     temp -       58) 
  - 0.000526 * pmax(0,      ibh -     1023) 
  +   0.0378 * pmax(0,      200 -      vis) 
  -   0.0168 * pmax(0,      doy -       89) 
  -   0.0871 * pmax(0,       89 -      doy) 
  -    9e-05 * pmax(0,       vh -     5550) * pmax(0,      doy -      151) 
  - 0.000226 * pmax(0,       vh -     5550) * pmax(0,      151 -      doy) 
  -   0.0172 * pmax(0,     wind -        7) * pmax(0,     1023 -      ibh) 
  -   0.0168 * pmax(0,       54 - humidity) * pmax(0,     temp -       58) 
  -   0.0159 * pmax(0,     temp -       58) * pmax(0,      dpg -       54) 
  - 0.000493 * pmax(0,      dpg -       -4) * pmax(0,      200 -      vis) 
  - 0.000719 * pmax(0,       -4 -      dpg) * pmax(0,      200 -      vis) 

Number of cases: 330
Selected 14 of 21 terms, and 8 of 9 predictors
Number of terms at each degree of interaction: 1 6 7
GCV: 13.7         RSS: 3663         GRSq: 0.786      RSq: 0.827
Selected 5 of 21 terms, and 4 of 9 predictors
Number of terms at each degree of interaction: 1 2 2
GCV: 18.1         RSS: 5567         GRSq: 0.72       RSq: 0.736

0 1 2 
1 2 2 
[1] 0 1 1 1 1 1 1 2 2
[1] "1" "2" "3"
[1] "vh"       "wind"     "humidity"
[1] 5567
[1] 1 2 3 4 5
     [,1]
[1,] 7.51
> 
> if(!interactive())
+     q(runLast=FALSE)  # needed else R prints the time on exit (R2.5 and higher)
